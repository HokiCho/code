<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모바일 바코드</title>
    
    <!-- 보안 헤더들 -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://unpkg.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self' https://apuvfmnwocpnfksowinh.supabase.co;
        font-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- PWA 매니페스트 -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- PWA 메타태그 -->
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="우리집바코드">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- 아이콘들 -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    <link rel="shortcut icon" href="/icons/icon-192x192.png">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
/* 기본 스타일 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 500px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* 헤더 */
header {
    text-align: center;
    margin-bottom: 30px;
    color: white;
}

header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

/* 섹션 */
.section {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    margin-bottom: 20px;
}

/* 폼 스타일 */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
}

.form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* 버튼 */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

.btn-copy {
    background: #28a745;
    color: white;
    padding: 8px 16px;
    font-size: 14px;
}

.btn-copy:hover {
    background: #218838;
}

/* 새로고침 섹션 */
.refresh-section {
    margin-top: 30px;
}

.refresh-section button {
    margin: 5px;
}

#request-new-barcode {
    background: #fd7e14;
}

#request-new-barcode:hover {
    background: #e8590c;
    transform: translateY(-1px);
}

.last-updated {
    margin-top: 15px;
    font-size: 14px;
    color: #6c757d;
}

/* 에러 메시지 */
.error-message {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #dc3545;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    z-index: 1000;
    max-width: 90%;
    text-align: center;
}

/* 나머지 스타일은 동일 */
.auth-links {
    text-align: center;
    margin-top: 20px;
}

.auth-links a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
}

.user-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f8f9fa;
}

.barcode-container {
    text-align: center;
}

.barcode-info {
    margin-bottom: 25px;
}

.barcode-info h3 {
    font-size: 1.5rem;
    margin-bottom: 15px;
    color: #333;
}

.barcode-meta {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
}

.time-info, .expires-info {
    background: #e9ecef;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
}

.time-info {
    color: #28a745;
}

.time-info.warning {
    color: #ffc107;
    background: #fff3cd;
    animation: pulse 1s infinite;
}

.time-info.expired {
    color: #dc3545;
    background: #f8d7da;
}

.expires-info {
    color: #dc3545;
}

.expires-info.warning {
    color: #ffc107;
    background: #fff3cd;
    animation: pulse 1s infinite;
}

.expires-info.expired {
    color: #dc3545;
    background: #f8d7da;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.barcode-image-container {
    background: white;
    border: 3px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin: 25px 0;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.barcode-image-container img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
}

.barcode-number {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 25px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
}

.barcode-number p {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    letter-spacing: 2px;
    margin: 0;
}

.loading {
    text-align: center;
    padding: 40px 20px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.no-data {
    text-align: center;
    padding: 40px 20px;
}

.no-data h3 {
    color: #6c757d;
    margin-bottom: 15px;
}

.no-data p {
    color: #6c757d;
    margin-bottom: 25px;
}

footer {
    text-align: center;
    color: white;
    opacity: 0.8;
    margin-top: auto;
    padding: 20px 0;
}

@media (max-width: 480px) {
    .container {
        padding: 15px;
    }
    
    header h1 {
        font-size: 2rem;
    }
    
    .section {
        padding: 20px;
    }
    
    .barcode-meta {
        flex-direction: column;
        align-items: center;
    }
    
    .barcode-number {
        flex-direction: column;
        text-align: center;
    }
    
    .user-info {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🏠 우리집바코드</h1>
            <p>실시간 모바일 바코드 조회</p>
            <button id="install-pwa" class="btn btn-secondary" style="display: none; position: absolute; top: 15px; right: 15px;">
                📱 앱 설치
            </button>
        </header>

        <!-- 로그인 폼 -->
        <div id="login-section" class="section">
            <div class="login-form">
                <h2>바코드 조회 로그인</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="email">사용자 ID</label>
                        <input type="text" id="email" required placeholder="사용자 ID 입력">
                    </div>
                    <div class="form-group">
                        <label for="password">비밀번호</label>
                        <input type="password" id="password" required placeholder="비밀번호 입력">
                    </div>
                    <button type="submit" class="btn btn-primary">로그인</button>
                </form>
                
                <div class="auth-links">
                    <p>🔒 인증된 사용자만 바코드 조회가 가능합니다</p>
                    <p style="font-size: 12px; color: #dc3545; font-style: italic;">보안을 위해 로그인 정보는 관리자에게 문의하세요</p>
                </div>
            </div>
        </div>

        <!-- 바코드 표시 섹션 -->
        <div id="barcode-section" class="section" style="display: none;">
            <div class="user-info">
                <span id="user-email"></span>
                <button id="logout-btn" class="btn btn-secondary">로그아웃</button>
            </div>

            <div class="barcode-container">
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>바코드 로딩 중...</p>
                </div>

                <div id="barcode-display" style="display: none;">
                    <div class="barcode-info">
                        <h3>현재 바코드</h3>
                        <div class="barcode-meta">
                            <span id="barcode-time" class="time-info"></span>
                            <span id="barcode-expires" class="expires-info"></span>
                        </div>
                    </div>

                    <div class="barcode-image-container">
                        <img id="barcode-image" alt="모바일 바코드" />
                    </div>

                    <div class="barcode-number">
                        <p id="barcode-number-display"></p>
                        <button id="copy-barcode" class="btn btn-copy">복사</button>
                    </div>

                    <div class="refresh-section">
                        <button id="refresh-barcode" class="btn btn-primary">📱 데이터 새로고침</button>
                        <button id="request-new-barcode" class="btn btn-secondary" style="display: none;">🔄 새 바코드 요청</button>
                        <p class="last-updated">마지막 업데이트: <span id="last-updated-time"></span></p>
                    </div>
                </div>

                <div id="no-barcode" style="display: none;">
                    <div class="no-data">
                        <h3>바코드가 없습니다</h3>
                        <p>아직 수집된 바코드가 없습니다. 잠시 후 다시 시도해주세요.</p>
                        <button id="retry-barcode" class="btn btn-primary">다시 시도</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 에러 메시지 -->
        <div id="error-message" class="error-message" style="display: none;">
            <p id="error-text"></p>
            <button id="close-error" class="btn btn-secondary">닫기</button>
        </div>
    </div>

    <footer>
    </footer>

    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://apuvfmnwocpnfksowinh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwdXZmbW53b2NwbmZrc293aW5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3ODA0NTksImV4cCI6MjA2NTM1NjQ1OX0.qlDKkIt-fSWtmpD3gvBE20aZOKpWjDmk37iz28ijTQM';

        // Supabase 클라이언트 초기화
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM 요소들
        const loginSection = document.getElementById('login-section');
        const barcodeSection = document.getElementById('barcode-section');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdSpan = document.getElementById('user-email');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const closeErrorBtn = document.getElementById('close-error');

        // 바코드 관련 요소들
        const loading = document.getElementById('loading');
        const barcodeDisplay = document.getElementById('barcode-display');
        const noBarcodeDiv = document.getElementById('no-barcode');
        const barcodeImage = document.getElementById('barcode-image');
        const barcodeNumberDisplay = document.getElementById('barcode-number-display');
        const barcodeTime = document.getElementById('barcode-time');
        const barcodeExpires = document.getElementById('barcode-expires');
        const lastUpdatedTime = document.getElementById('last-updated-time');
        const refreshBarcodeBtn = document.getElementById('refresh-barcode');
        const requestNewBarcodeBtn = document.getElementById('request-new-barcode');
        const retryBarcodeBtn = document.getElementById('retry-barcode');
        const copyBarcodeBtn = document.getElementById('copy-barcode');

        // 현재 사용자 정보
        let currentUserInfo = null;

        // 카운트다운 타이머
        let countdownTimer = null;
        
        // 세션 체크 타이머
        let sessionCheckTimer = null;
        
        // 자동 새로고침 스케줄 타이머
        let refreshScheduleTimer = null;

        // 로그인 보안 (브루트포스 공격 방지)
        let loginAttempts = 0;
        let loginBlocked = false;
        const MAX_LOGIN_ATTEMPTS = 3;
        const LOCKOUT_TIME = 15 * 60 * 1000; // 15분

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // PWA 서비스워커 등록
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('서비스워커 등록 성공:', registration);
                    })
                    .catch(error => {
                        console.log('서비스워커 등록 실패:', error);
                    });
            }
            
            // PWA 설치 이벤트 리스너
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA 설치 프롬프트 감지');
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-pwa').style.display = 'inline-block';
            });
            
            // iOS Safari 감지 및 설치 안내
            function isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent);
            }
            
            function isInStandaloneMode() {
                return window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone === true;
            }
            
            // iOS에서 PWA가 설치되지 않은 경우 안내
            if (isIOS() && !isInStandaloneMode()) {
                setTimeout(() => {
                    const installBtn = document.getElementById('install-pwa');
                    installBtn.style.display = 'inline-block';
                    installBtn.textContent = '🍎 iOS 설치';
                    installBtn.onclick = showIOSInstallGuide;
                }, 3000); // 3초 후 표시
            }
            
            // 앱이 이미 설치된 경우
            window.addEventListener('appinstalled', () => {
                console.log('PWA 앱 설치 완료');
                document.getElementById('install-pwa').style.display = 'none';
                deferredPrompt = null;
                showSuccess('우리집바코드 앱이 설치되었습니다! 홈화면에서 확인하세요.');
            });
            
            // 세션 스토리지에서 사용자 정보 확인
            const savedUser = sessionStorage.getItem('user_session');
            
            if (savedUser) {
                const session = JSON.parse(savedUser);
                
                // 세션 만료 체크
                if (Date.now() < session.expiresAt) {
                    currentUserInfo = session;
                    showBarcodeSection();
                } else {
                    // 만료된 세션 정리
                    sessionStorage.removeItem('user_session');
                    showLoginSection();
                }
            } else {
                showLoginSection();
            }

            // 이벤트 리스너 등록
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            refreshBarcodeBtn.addEventListener('click', loadBarcodeFromDatabase);
            requestNewBarcodeBtn.addEventListener('click', handleRequestNewBarcode);
            retryBarcodeBtn.addEventListener('click', loadBarcodeFromDatabase);
            copyBarcodeBtn.addEventListener('click', copyBarcodeNumber);
            closeErrorBtn.addEventListener('click', hideError);
            
            // PWA 설치 버튼 이벤트
            document.getElementById('install-pwa').addEventListener('click', installPWA);
        });

        // 세션 유효성 체크 함수
        function checkSessionValidity() {
            const savedUser = sessionStorage.getItem('user_session');
            
            if (savedUser && currentUserInfo) {
                const session = JSON.parse(savedUser);
                
                if (Date.now() >= session.expiresAt) {
                    // 세션 만료 시 자동 로그아웃
                    showError('세션이 만료되었습니다. 다시 로그인해주세요.');
                    handleLogout();
                }
            }
        }

        // 세션 자동 체크 시작
        function startSessionCheck() {
            // 기존 타이머 정리
            if (sessionCheckTimer) {
                clearInterval(sessionCheckTimer);
            }
            
            // 1분마다 세션 체크
            sessionCheckTimer = setInterval(checkSessionValidity, 60000);
        }

        // 세션 자동 체크 중단
        function stopSessionCheck() {
            if (sessionCheckTimer) {
                clearInterval(sessionCheckTimer);
                sessionCheckTimer = null;
            }
        }

        // 로그인 처리 (Edge Function 사용)
        async function handleLogin(e) {
            e.preventDefault();
            
            // 브루트포스 공격 방지 체크
            if (loginBlocked) {
                showError('너무 많은 로그인 시도로 인해 15분간 차단되었습니다.');
                return;
            }
            
            const username = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showError('사용자 ID와 비밀번호를 입력해주세요.');
                return;
            }
            
            try {
                // Edge Function을 통한 인증 (서버사이드에서 해싱 및 검증 처리)
                const { data, error } = await supabase.functions.invoke('auth', {
                    body: {
                        username: username,
                        password: password
                    }
                });
                
                if (error) throw error;
                
                if (data?.success) {
                    // 인증 성공
                    loginAttempts = 0;
                    currentUserInfo = { 
                        username: data.user.username,
                        loginTime: Date.now(),
                        expiresAt: Date.now() + (30 * 60 * 1000) // 30분 만료
                    };
                    sessionStorage.setItem('user_session', JSON.stringify(currentUserInfo));
                    showBarcodeSection();
                } else {
                    // 인증 실패
                    loginAttempts++;
                    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                        loginBlocked = true;
                        setTimeout(() => {
                            loginBlocked = false;
                            loginAttempts = 0;
                        }, LOCKOUT_TIME);
                        showError(`로그인 실패. ${MAX_LOGIN_ATTEMPTS}회 실패로 15분간 차단됩니다.`);
                    } else {
                        showError(`로그인 실패. ${MAX_LOGIN_ATTEMPTS - loginAttempts}회 남음.`);
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showError('로그인에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 로그아웃 처리
        function handleLogout() {
            currentUserInfo = null;
            sessionStorage.removeItem('user_session');
            
            // 모든 타이머 정리
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // 자동 새로고침 스케줄 중지
            stopAutoRefreshSchedule();
            
            // 세션 체크 중단
            stopSessionCheck();
            
            showLoginSection();
            
            // 폼 초기화
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // 로그인 섹션 표시
        function showLoginSection() {
            loginSection.style.display = 'block';
            barcodeSection.style.display = 'none';
        }

        // 바코드 섹션 표시
        function showBarcodeSection() {
            loginSection.style.display = 'none';
            barcodeSection.style.display = 'block';
            userIdSpan.textContent = currentUserInfo.username;
            
            // 세션 자동 체크 시작
            startSessionCheck();
            
            // 바코드 로드 (최초 로그인 플래그 설정)
            loadBarcodeFromDatabase(true);
        }

        // Edge Function을 통한 바코드 데이터 로드
        async function loadBarcodeFromDatabase(isInitialLogin = false, isAutoRefresh = false) {
            showLoading();
            
            try {
                // Edge Function을 통한 바코드 조회
                const { data, error } = await supabase.functions.invoke('get-barcode', {
                    body: {}
                });
                
                if (error) throw error;
                
                if (data?.success && data?.data) {
                    // Edge Function이 배열로 반환하므로 첫 번째 요소를 사용
                    const barcodeData = Array.isArray(data.data) ? data.data[0] : data.data;
                    displayBarcode(barcodeData, isInitialLogin, isAutoRefresh);
                } else {
                    showNoBarcode();
                }
            } catch (error) {
                console.error('Barcode load error:', error);
                showError('바코드를 불러올 수 없습니다. 새로고침을 시도해주세요.');
                showNoBarcode();
            }
        }

        // 바코드 표시
        function displayBarcode(barcode, isInitialLogin = false, isAutoRefresh = false) {
            console.log('Received barcode data:', barcode);
            // 기존 카운트다운 타이머 정리
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // 새 바코드 요청 버튼 초기에 숨김
            requestNewBarcodeBtn.style.display = 'none';
            
            // 바코드 이미지
            if (barcode.barcode_image_url) {
                barcodeImage.src = barcode.barcode_image_url;
                barcodeImage.style.display = 'block';
            } else {
                barcodeImage.style.display = 'none';
            }
            
            // 바코드 번호 (포맷팅)
            const formattedNumber = formatBarcodeNumber(barcode.barcode_data);
            barcodeNumberDisplay.textContent = formattedNumber;
            
            // 만료 여부 확인
            const now = new Date().getTime();
            const expiresAt = barcode.expires_at ? new Date(barcode.expires_at).getTime() : null;
            const isExpired = !expiresAt || now >= expiresAt;
            
            // 자동 새로고침 중에 만료되지 않은 바코드를 받아오면 새로고침 중지
            if (isAutoRefresh && !isExpired) {
                console.log('만료되지 않은 바코드 감지 - 자동 새로고침 스케줄 중지');
                stopAutoRefreshSchedule();
                showSuccess('새로운 바코드가 성공적으로 업데이트되었습니다!');
            }
            
            // 1. 최초 로그인시 만료된 바코드일 경우 자동으로 새 바코드 요청
            if (isInitialLogin && isExpired) {
                console.log('최초 로그인 - 만료된 바코드 감지, 자동으로 새 바코드 요청');
                requestNewBarcodeAutomatically();
                return;
            }
            
            // 실시간 카운트다운 시작
            if (barcode.expires_at) {
                const expiresDate = new Date(barcode.expires_at);
                startCountdown(expiresDate);
            } else {
                barcodeTime.style.display = 'none';
                barcodeExpires.style.display = 'none';
            }
            
            // 마지막 업데이트 시간
            if (barcode.updated_at) {
                const updatedDate = new Date(barcode.updated_at);
                lastUpdatedTime.textContent = updatedDate.toLocaleString('ko-KR');
            }
            
            // 바코드 표시
            hideLoading();
            barcodeDisplay.style.display = 'block';
            noBarcodeDiv.style.display = 'none';
        }

        // 바코드 번호 포맷팅
        function formatBarcodeNumber(barcodeData) {
            if (!barcodeData) return '';
            
            // 4자리씩 공백으로 구분
            return barcodeData.replace(/(\d{4})(?=\d)/g, '$1 ');
        }

        // 실시간 카운트다운 시작
        function startCountdown(expiresDate) {
            function updateCountdown() {
                const now = new Date();
                const timeLeft = expiresDate - now;
                
                if (timeLeft <= 0) {
                    // 만료됨
                    barcodeTime.textContent = '만료됨';
                    barcodeTime.className = 'time-info expired';
                    barcodeExpires.textContent = '새 바코드 필요';
                    barcodeExpires.className = 'expires-info expired';
                    
                    // 새 바코드 요청 버튼 표시
                    requestNewBarcodeBtn.style.display = 'inline-block';
                    
                    // 타이머 정리
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                    }
                    
                    return;
                }
                
                // 남은 시간 계산 (분:초 형식)
                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                // 시간 표시 업데이트
                barcodeTime.textContent = `남은 시간: ${minutes}분 ${seconds}초`;
                
                // 만료 시간 표시
                barcodeExpires.textContent = `만료: ${expiresDate.toLocaleString('ko-KR')}`;
                
                // 경고 상태 업데이트
                if (timeLeft <= 60000) { // 1분 이하
                    barcodeTime.className = 'time-info expired';
                    barcodeExpires.className = 'expires-info expired';
                } else if (timeLeft <= 300000) { // 5분 이하
                    barcodeTime.className = 'time-info warning';
                    barcodeExpires.className = 'expires-info warning';
                } else {
                    barcodeTime.className = 'time-info';
                    barcodeExpires.className = 'expires-info';
                }
                
                // 만료되지 않은 상태에서는 새 바코드 요청 버튼 숨김
                requestNewBarcodeBtn.style.display = 'none';
                
                // 표시 활성화
                barcodeTime.style.display = 'inline-block';
                barcodeExpires.style.display = 'inline-block';
            }
            
            // 즉시 한번 실행
            updateCountdown();
            
            // 1초마다 업데이트
            countdownTimer = setInterval(updateCountdown, 1000);
        }

        // 새 바코드 요청 (Edge Function 호출) - 사용자 클릭용
        async function handleRequestNewBarcode(e) {
            const triggerBtn = e.target;
            
            try {
                // 버튼 상태 변경
                triggerBtn.textContent = '요청 중...';
                triggerBtn.disabled = true;

                // Supabase Edge Function 호출
                const { data, error } = await supabase.functions.invoke('collect-barcode', {
                    method: 'POST',
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Edge Function이 성공적으로 실행됨
                showSuccess('새 바코드 요청이 전송되었습니다. 잠시 후 새로운 바코드가 자동으로 업데이트됩니다.');
                
                // 2. 새바코드 요청이 되었을 경우 새바코드 요청 버튼은 숨김 처리
                triggerBtn.style.display = 'none';
                
                // 3, 4. 자동 새로고침 스케줄링 시작
                startAutoRefreshSchedule();
                
            } catch (error) {
                console.error('Request new barcode error:', error);
                showError('새 바코드 요청에 실패했습니다. 잠시 후 다시 시도해주세요.');
                // 버튼 상태 복원
                triggerBtn.textContent = '🔄 새 바코드 요청';
                triggerBtn.disabled = false;
            }
        }

        // 자동 새 바코드 요청 함수 (최초 로그인시 만료된 경우)
        async function requestNewBarcodeAutomatically() {
            try {
                console.log('자동 새 바코드 요청 시작...');
                
                // 로딩 표시
                showLoading();
                showSuccess('만료된 바코드가 감지되었습니다. 새로운 바코드를 요청 중...');

                // Supabase Edge Function 호출
                const { data, error } = await supabase.functions.invoke('collect-barcode', {
                    method: 'POST',
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Edge Function이 성공적으로 실행됨
                showSuccess('새 바코드 요청이 전송되었습니다. 잠시 후 새로운 바코드가 자동으로 업데이트됩니다.');
                
                // 2. 새바코드 요청이 되었을 경우 새바코드 요청 버튼은 숨김 처리
                requestNewBarcodeBtn.style.display = 'none';
                
                // 3, 4. 자동 새로고침 스케줄링 시작
                startAutoRefreshSchedule();
                
            } catch (error) {
                console.error('Automatic request new barcode error:', error);
                showError('자동 바코드 요청에 실패했습니다. 수동으로 새로고침을 시도해주세요.');
                showNoBarcode();
            }
        }

        // 자동 새로고침 interval timer 저장용
        let autoRefreshInterval = null;
        
        // PWA 설치 프롬프트
        let deferredPrompt = null;
        
        // 3, 4. 자동 새로고침 스케줄링 (30초 후 시작, 이후 10초 간격으로 4회)
        function startAutoRefreshSchedule() {
            console.log('자동 새로고침 스케줄 시작');
            
            // 기존 스케줄 타이머들 정리
            stopAutoRefreshSchedule();
            
            // 3. 새바코드 요청이 되었을 경우 최초 30초 후 데이터 새로고침 실행
            refreshScheduleTimer = setTimeout(() => {
                console.log('30초 후 첫 번째 자동 새로고침 실행');
                loadBarcodeFromDatabase(false, true); // 자동 새로고침 플래그 설정
                
                // 4. 이후 10초 간격으로 4회 데이터 새로고침 실행
                let refreshCount = 0;
                autoRefreshInterval = setInterval(() => {
                    refreshCount++;
                    console.log(`10초 간격 자동 새로고침 실행 (${refreshCount}/4)`);
                    loadBarcodeFromDatabase(false, true); // 자동 새로고침 플래그 설정
                    
                    if (refreshCount >= 4) {
                        stopAutoRefreshSchedule();
                        console.log('자동 새로고침 스케줄 완료');
                    }
                }, 10000); // 10초 간격
                
            }, 30000); // 30초 후
        }
        
        // 자동 새로고침 스케줄 중지
        function stopAutoRefreshSchedule() {
            if (refreshScheduleTimer) {
                clearTimeout(refreshScheduleTimer);
                refreshScheduleTimer = null;
            }
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            console.log('자동 새로고침 스케줄 중지');
        }

        // 바코드 번호 복사
        async function copyBarcodeNumber() {
            try {
                const barcodeText = barcodeNumberDisplay.textContent;
                await navigator.clipboard.writeText(barcodeText);
                
                // 복사 완료 피드백
                const originalText = copyBarcodeBtn.textContent;
                copyBarcodeBtn.textContent = '복사됨!';
                setTimeout(() => {
                    copyBarcodeBtn.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Copy failed:', error);
                showError('복사에 실패했습니다. 수동으로 복사해주세요.');
            }
        }
        
        // PWA 설치 함수
        async function installPWA() {
            if (!deferredPrompt) {
                showError('앱 설치가 지원되지 않는 환경입니다.');
                return;
            }
            
            try {
                // 설치 프롬프트 표시
                deferredPrompt.prompt();
                
                // 사용자의 응답 대기
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('사용자가 PWA 설치를 승인했습니다');
                    showSuccess('앱 설치가 시작되었습니다!');
                } else {
                    console.log('사용자가 PWA 설치를 거부했습니다');
                }
                
                // 프롬프트는 한 번만 사용 가능
                deferredPrompt = null;
                document.getElementById('install-pwa').style.display = 'none';
                
            } catch (error) {
                console.error('PWA 설치 중 오류:', error);
                showError('앱 설치 중 오류가 발생했습니다.');
            }
        }
        
        // iOS 설치 안내 함수
        function showIOSInstallGuide() {
            const guideMessage = `
📱 iPhone/iPad에서 앱 설치 방법:

1. 하단 공유 버튼 📤 터치
2. "홈 화면에 추가" 선택
3. "추가" 버튼 터치

그러면 우리집바코드가 홈화면에 앱으로 추가됩니다!
            `.trim();
            
            // 간단한 모달 스타일 알림
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #333;">🏠 우리집바코드 설치</h3>
                <p style="line-height: 1.6; white-space: pre-line; margin: 0 0 20px 0;">${guideMessage}</p>
                <button onclick="this.closest('.modal').remove()" 
                        style="background: #667eea; color: white; border: none; 
                               padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                    확인
                </button>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 배경 클릭시 닫기
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // 로딩 표시
        function showLoading() {
            loading.style.display = 'block';
            barcodeDisplay.style.display = 'none';
            noBarcodeDiv.style.display = 'none';
        }

        // 로딩 숨김
        function hideLoading() {
            loading.style.display = 'none';
        }

        // 바코드 없음 표시
        function showNoBarcode() {
            hideLoading();
            barcodeDisplay.style.display = 'none';
            noBarcodeDiv.style.display = 'block';
        }

        // 에러 메시지 표시
        function showError(message) {
            errorText.textContent = message;
            errorMessage.style.background = '#dc3545';
            errorMessage.style.display = 'block';
            
            // 5초 후 자동 숨김
            setTimeout(hideError, 5000);
        }

        // 성공 메시지 표시
        function showSuccess(message) {
            errorText.textContent = message;
            errorMessage.style.background = '#28a745';
            errorMessage.style.display = 'block';
            
            // 3초 후 자동 숨김
            setTimeout(hideError, 3000);
        }

        // 에러 메시지 숨김
        function hideError() {
            errorMessage.style.display = 'none';
        }
    </script>
</body>

</html>

